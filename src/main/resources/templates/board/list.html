<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml" layout:decorator="layout">

<th:block layout:fragment="content">
    <form id="logout" action="/logout" method="POST">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <input type="submit" value="logout">
    </form>

    <div>
        <!-- 게시글 -->
        <table>
            <thead>
            <tr>
                <th>번호</th>
                <th>제목</th>
                <th>내용</th>
                <th>작성자</th>
                <th>작성일시</th>
                <th>수정자</th>
                <th>수정일시</th>
                <th>조회 수</th>
            </tr>
            </thead>

            <!-- 게시글 리스트 -->
            <tbody id="list">
            </tbody>

        </table>

        <!-- 페이징 -->
        <nav id="page">
        </nav>
    </div>

    <!-- 옵션 -->
    <div>
        <form id="optionForm">
            <select id="pageSize" style="width: 100px;" onchange="onSelectAction()">
                <option th:value="5"  th:text="5"></option>
                <option th:value="10" th:text="10" selected></option>
                <option th:value="15" th:text="15"></option>
                <option th:value="20" th:text="20"></option>
            </select>
            <button type="button" onclick="onOpenViewAction('/boards/write')">write -></button>
        </form>
    </div>
    <!-- 검색 -->
    <div>
        <form id="searchForm">
            <select id="searchType" style="width: 100px;">
                <option value="TITLE" selected>제목</option>
                <option value="CONTENT">내용</option>
                <option value="WRITER">작성자</option>
            </select>
            <input type="text" id="searchKeyword" placeholder="키워드를 입력해 주세요." style="width: 300px;"/>
            <button type="button" onclick="onSelectAction()">조회</button>
        </form>
    </div>
</th:block>


<th:block layout:fragment="script">
    <script th:inline="javascript">

        // 페이지 로드시 조회
        window.onload = () => {
            onSelectAction();
        }

        // 조회
        function onSelectAction(_page) {
            const searchForm = document.getElementById("searchForm");
            const optionForm = document.getElementById("optionForm");

            const page = _page;
            const size = optionForm.pageSize.options[pageSize.selectedIndex].value;
            let searchType    = searchForm.searchType.value.trim();
            let searchKeyword = searchForm.searchKeyword.value.trim();

            fetch('/api/boards?' + new URLSearchParams({
                page, size, searchType, searchKeyword

            })).then(response => {
                if (response.ok) {
                    return response.json();
                }
            }).then(json => {
                let html = '';
                const result = json.RESULT;
                const list = result.content;
                const page = result.pageable;
                const startPage = json.startPage;
                const endPage = json.endPage;

                /* list */
                if (!list.length) {
                    html = '<td colspan="7">게시글이 없습니다.</td>';

                } else {
                    list.forEach((board, idx) => {
                        html += `
							<tr>
    							<td>${result.totalElements - (idx + (page.pageSize * page.pageNumber))}</td>
    							<td class="text-left">
    								<a href="javascript: void(0);" onclick="onOpenViewAction('/boards/'+${board.boardId})">${board.title}</a>
    							</td>
    							<td>${board.contents}</td>
    							<td>${board.createdId}</td>
    							<td>${board.createdDate}</td>
    							<td>${board.modifiedId}</td>
    							<td>${board.modifiedDate}</td>
    							<td>${board.hit}</td>
							</tr>
						`;
                    });
                }
                document.getElementById('list').innerHTML = html;

                /* paging */
                html = `
                    <a href="javascript: void(0);" class="${0 == page.pageNumber} ? 'disable':''" onclick="onSelectAction(0)"><<</a> |
                    <a href="javascript: void(0);" class="${startPage == page.pageNumber} ? 'disable':''" onclick="onSelectAction(${startPage-1})"><</a> |
                `;

                for(let i=startPage ; i<=endPage ; i++){
                    html += `<a href="javascript: void(0);" class="${page.pageNumber == i} ? 'disable':''" onclick="onSelectAction(${i-1})">${i}${page.pageNumber == i-1?'V':''}</a> | `;
                }
                html += `
                    <a href="javascript: void(0);" class="${endPage == page.pageNumber} ? 'disable':''" onclick="onSelectAction(${endPage-1})">></a> |
                    <a href="javascript: void(0);" class="${result.totalPages == page.pageNumber} ? 'disable':''" onclick="onSelectAction(${result.totalPages-1})">>></a>
                `;
                document.getElementById('page').innerHTML = html;

            });
        }

        // 게시글 선택
        function onOpenViewAction(_path) {
            location.href = _path;
        }

    </script>
</th:block>

</html>